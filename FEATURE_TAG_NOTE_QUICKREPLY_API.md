# 客户标签、会话备注、快捷回复功能 API 文档

## 概述

本文档详细说明三个核心功能的完整 REST API 接口:

1. **客户标签管理**: 支持客服手动和AI自动添加/删除客户标签
2. **会话备注管理**: 每个会话只能有一个备注,支持创建和修改
3. **快捷回复管理**: 客服可管理自己的快捷回复,系统预设不可删除

---

## 一、客户标签管理 API

### 1.1 获取客户所有标签

**接口**: `GET /api/v1/customers/{customerId}/tags`

**描述**: 获取指定客户的所有标签列表

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| customerId | UUID | 是 | 客户ID |

**响应示例**:
```json
[
  "VIP客户",
  "技术问题",
  "待跟进",
  "高价值"
]
```

**状态码**:
- `200 OK`: 成功返回标签列表
- `404 Not Found`: 客户不存在

---

### 1.2 添加客户标签

**接口**: `POST /api/v1/customers/{customerId}/tags`

**描述**: 为客户添加单个标签,支持客服手动添加和AI自动添加

**权限**: 需要客服认证或AI系统权限

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| customerId | UUID | 是 | 客户ID |

**请求体**:
```json
{
  "tag": "VIP客户"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| tag | String | 是 | 标签名称,不能为空 |

**响应示例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "张三",
  "primaryChannel": "WECHAT",
  "email": "zhangsan@example.com",
  "phone": "13800138000",
  "avatarUrl": "https://example.com/avatar.jpg",
  "location": "北京",
  "notes": "重要客户",
  "tags": ["VIP客户", "技术问题"],
  "metadata": {},
  "active": true,
  "lastInteractionAt": "2024-01-20T10:30:00Z",
  "createdAt": "2024-01-15T08:00:00Z"
}
```

**状态码**:
- `200 OK`: 成功添加标签
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 客户不存在

**备注**:
- 如果标签已存在,不会重复添加
- 标签名称区分大小写
- 适用于客服手动标记和AI自动分析后添加标签

---

### 1.3 删除客户标签

**接口**: `DELETE /api/v1/customers/{customerId}/tags`

**描述**: 删除客户的指定标签,支持客服手动删除和AI自动删除

**权限**: 需要客服认证或AI系统权限

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| customerId | UUID | 是 | 客户ID |

**请求体**:
```json
{
  "tag": "待跟进"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| tag | String | 是 | 要删除的标签名称 |

**响应示例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "张三",
  "tags": ["VIP客户"],
  ...
}
```

**状态码**:
- `200 OK`: 成功删除标签
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 客户不存在

**备注**:
- 如果标签不存在,操作仍然返回成功
- 适用于客服手动移除和AI自动清理过期标签

---

### 1.4 批量设置客户标签

**接口**: `PUT /api/v1/customers/{customerId}/tags`

**描述**: 批量设置客户标签,会覆盖现有所有标签,主要用于AI批量操作

**权限**: 需要AI系统权限或高级客服权限

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| customerId | UUID | 是 | 客户ID |

**请求体**:
```json
[
  "VIP客户",
  "技术专家",
  "高频用户"
]
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| - | String[] | 是 | 标签数组,会完全替换现有标签 |

**响应示例**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "张三",
  "tags": ["VIP客户", "技术专家", "高频用户"],
  ...
}
```

**状态码**:
- `200 OK`: 成功设置标签
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 客户不存在

**备注**:
- 此操作会清空原有标签,请谨慎使用
- 主要用于AI分析后批量更新客户画像标签

---

## 二、会话备注管理 API

**设计说明**: 会话备注直接存储在`chat_sessions`表的`note`字段中,每个会话只能有一个备注。

### 2.1 获取会话备注

**接口**: `GET /api/v1/chat/sessions/{sessionId}/note`

**描述**: 获取指定会话的备注信息

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sessionId | UUID | 是 | 会话ID |

**响应示例**:
```json
"客户反馈产品使用体验很好,有升级意向"
```

**响应**: 直接返回备注文本内容(String类型)

**状态码**:
- `200 OK`: 成功返回备注
- `404 Not Found`: 备注不存在或为空

---

### 2.2 创建会话备注

**接口**: `POST /api/v1/chat/sessions/{sessionId}/note`

**描述**: 为会话创建备注,每个会话只能有一个备注

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sessionId | UUID | 是 | 会话ID |

**请求体**:
```json
{
  "content": "客户对新功能很感兴趣,建议重点跟进"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| content | String | 是 | 备注内容,不能为空 |

**响应示例**:
```json
"客户对新功能很感兴趣,建议重点跟进"
```

**状态码**:
- `201 Created`: 成功创建备注
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 会话不存在
- `409 Conflict`: 该会话已有备注,请使用更新接口

**备注**:
- 每个会话只能有一个备注
- 如果需要修改备注,请使用更新接口(`PUT`)

---

### 2.3 更新会话备注

**接口**: `PUT /api/v1/chat/sessions/{sessionId}/note`

**描述**: 更新会话备注内容,如果备注不存在则自动创建

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sessionId | UUID | 是 | 会话ID |

**请求体**:
```json
{
  "content": "客户已确认购买意向,转交销售团队跟进"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| content | String | 是 | 更新后的备注内容 |

**响应示例**:
```json
"客户已确认购买意向,转交销售团队跟进"
```

**状态码**:
- `200 OK`: 成功更新备注
- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 会话不存在

**备注**:
- 如果备注不存在,会自动创建新备注
- 更新操作会记录最后修改的客服信息
- 推荐使用此接口进行备注的创建和更新

---

### 2.4 删除会话备注

**接口**: `DELETE /api/v1/chat/sessions/{sessionId}/note`

**描述**: 删除会话的备注信息

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sessionId | UUID | 是 | 会话ID |

**响应**: 无响应体

**状态码**:
- `204 No Content`: 成功删除备注
- `404 Not Found`: 备注不存在

---

## 三、快捷回复管理 API

### 3.1 获取所有快捷回复

**接口**: `GET /api/v1/quick-replies`

**描述**: 获取当前客服可用的所有快捷回复,包括系统预设和自己创建的

**权限**: 需要客服认证

**响应示例**:
```json
[
  {
    "id": "990e8400-e29b-41d4-a716-446655440001",
    "label": "欢迎语",
    "text": "您好,很高兴为您服务!",
    "category": "问候",
    "system": true
  },
  {
    "id": "990e8400-e29b-41d4-a716-446655440002",
    "label": "技术支持",
    "text": "请详细描述您遇到的问题,我会尽快帮您解决。",
    "category": "技术",
    "system": false
  }
]
```

**响应字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 快捷回复ID |
| label | String | 显示标签 |
| text | String | 回复内容 |
| category | String | 分类(可选) |
| system | Boolean | 是否为系统预设 |

**状态码**:
- `200 OK`: 成功返回快捷回复列表

**备注**:
- 系统预设的快捷回复所有客服共享
- 客服创建的快捷回复只有自己可见

---

### 3.2 获取单个快捷回复

**接口**: `GET /api/v1/quick-replies/{id}`

**描述**: 获取指定快捷回复的详细信息

**权限**: 需要客服认证

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | UUID | 是 | 快捷回复ID |

**响应示例**:
```json
{
  "id": "990e8400-e29b-41d4-a716-446655440001",
  "label": "欢迎语",
  "text": "您好,很高兴为您服务!",
  "category": "问候",
  "system": true
}
```

**状态码**:
- `200 OK`: 成功返回快捷回复
- `404 Not Found`: 快捷回复不存在

---

### 3.3 创建快捷回复

**接口**: `POST /api/v1/quick-replies`

**描述**: 创建个人快捷回复

**权限**: 需要客服认证

**请求体**:
```json
{
  "label": "产品介绍",
  "text": "我们的产品具有以下特点:1)高性能 2)易用性 3)稳定性",
  "category": "产品"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| label | String | 是 | 显示标签,不能为空 |
| text | String | 是 | 回复内容,不能为空 |
| category | String | 否 | 分类标签 |

**响应示例**:
```json
{
  "id": "990e8400-e29b-41d4-a716-446655440003",
  "label": "产品介绍",
  "text": "我们的产品具有以下特点:1)高性能 2)易用性 3)稳定性",
  "category": "产品",
  "system": false
}
```

**状态码**:
- `201 Created`: 成功创建快捷回复
- `400 Bad Request`: 请求参数错误

---

### 3.4 更新快捷回复

**接口**: `PUT /api/v1/quick-replies/{id}`

**描述**: 更新快捷回复内容,只能修改自己创建的非系统回复

**权限**: 需要客服认证,且只能修改自己创建的

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | UUID | 是 | 快捷回复ID |

**请求体**:
```json
{
  "label": "产品优势介绍",
  "text": "我们的产品优势包括:1)卓越性能 2)简单易用 3)高度稳定 4)优质服务",
  "category": "产品"
}
```

**请求参数说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| label | String | 是 | 更新后的标签 |
| text | String | 是 | 更新后的内容 |
| category | String | 否 | 更新后的分类 |

**响应示例**:
```json
{
  "id": "990e8400-e29b-41d4-a716-446655440003",
  "label": "产品优势介绍",
  "text": "我们的产品优势包括:1)卓越性能 2)简单易用 3)高度稳定 4)优质服务",
  "category": "产品",
  "system": false
}
```

**状态码**:
- `200 OK`: 成功更新快捷回复
- `400 Bad Request`: 请求参数错误
- `403 Forbidden`: 无权修改(系统预设或他人创建)
- `404 Not Found`: 快捷回复不存在

**备注**:
- 系统预设的快捷回复不可修改
- 只能修改自己创建的快捷回复

---

### 3.5 删除快捷回复

**接口**: `DELETE /api/v1/quick-replies/{id}`

**描述**: 删除快捷回复,只能删除自己创建的非系统回复

**权限**: 需要客服认证,且只能删除自己创建的

**路径参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | UUID | 是 | 快捷回复ID |

**响应**: 无响应体

**状态码**:
- `204 No Content`: 成功删除快捷回复
- `403 Forbidden`: 无权删除(系统预设或他人创建)
- `404 Not Found`: 快捷回复不存在

**备注**:
- 系统预设的快捷回复不可删除
- 只能删除自己创建的快捷回复

---

## 四、权限说明

### 4.1 客户标签权限

| 操作 | 客服 | AI系统 | 说明 |
|------|------|--------|------|
| 获取标签 | ✅ | ✅ | 所有角色可查看 |
| 添加标签 | ✅ | ✅ | 客服手动或AI自动添加 |
| 删除标签 | ✅ | ✅ | 客服手动或AI自动删除 |
| 批量设置 | ⚠️ | ✅ | 需要高级权限,主要用于AI |

### 4.2 会话备注权限

| 操作 | 客服 | 说明 |
|------|------|------|
| 获取备注 | ✅ | 所有客服可查看 |
| 创建备注 | ✅ | 任何客服可创建 |
| 更新备注 | ✅ | 任何客服可更新 |
| 删除备注 | ✅ | 任何客服可删除 |

**备注**: 备注直接存储在`chat_sessions`表的`note`字段,不记录创建人和修改人信息。

### 4.3 快捷回复权限

| 操作 | 系统预设 | 个人创建 | 他人创建 |
|------|----------|----------|----------|
| 查看 | ✅ | ✅ | ❌ |
| 创建 | N/A | ✅ | N/A |
| 修改 | ❌ | ✅ | ❌ |
| 删除 | ❌ | ✅ | ❌ |

---

## 五、错误码说明

### 5.1 通用错误码

| 状态码 | 说明 |
|--------|------|
| 400 Bad Request | 请求参数错误或格式不正确 |
| 401 Unauthorized | 未认证或token无效 |
| 403 Forbidden | 无权限执行此操作 |
| 404 Not Found | 资源不存在 |
| 409 Conflict | 资源冲突(如重复创建) |
| 500 Internal Server Error | 服务器内部错误 |

### 5.2 业务错误示例

**标签操作错误**:
```json
{
  "error": "Bad Request",
  "message": "标签不能为空",
  "status": 400
}
```

**备注冲突错误**:
```json
{
  "error": "Conflict",
  "message": "该会话已有备注,请使用更新接口修改",
  "status": 409
}
```

**权限错误**:
```json
{
  "error": "Forbidden",
  "message": "系统预设快捷回复不可删除",
  "status": 403
}
```

---

## 六、使用场景示例

### 6.1 客服手动添加标签
```bash
# 客服在与客户沟通后,手动添加"VIP客户"标签
POST /api/v1/customers/550e8400-e29b-41d4-a716-446655440000/tags
{
  "tag": "VIP客户"
}
```

### 6.2 AI自动添加标签
```bash
# AI分析对话后,自动为客户添加"技术问题"标签
POST /api/v1/customers/550e8400-e29b-41d4-a716-446655440000/tags
{
  "tag": "技术问题"
}
```

### 6.3 创建会话备注
```bash
# 客服在会话结束前添加备注
POST /api/v1/chat/sessions/770e8400-e29b-41d4-a716-446655440002/note
{
  "content": "客户反馈产品体验良好,有升级意向,建议3天后回访"
}
```

### 6.4 更新会话备注
```bash
# 客服更新之前的备注
PUT /api/v1/chat/sessions/770e8400-e29b-41d4-a716-446655440002/note
{
  "content": "客户已确认升级,已转交销售团队处理"
}
```

### 6.5 客服创建个人快捷回复
```bash
# 客服创建常用的产品介绍模板
POST /api/v1/quick-replies
{
  "label": "产品功能介绍",
  "text": "我们的产品提供以下核心功能:\n1. 智能客服系统\n2. 数据分析报表\n3. 多渠道整合",
  "category": "产品"
}
```

---

## 七、数据库变更

### 7.1 表结构修改

**chat_sessions 表** (添加备注字段):
```sql
ALTER TABLE chat_sessions ADD COLUMN note TEXT DEFAULT NULL COMMENT '会话备注';
```

**说明**:
- 备注直接存储在`chat_sessions`表中,每个会话对应一个备注
- 无需单独创建`session_notes`表
- 备注字段允许为NULL,表示该会话暂无备注

---

## 八、注意事项

### 8.1 客户标签
- 标签名称区分大小写
- 重复添加相同标签不会报错,会自动去重
- 批量设置标签会完全覆盖现有标签,请谨慎使用

### 8.2 会话备注
- 每个会话只能有一个备注,直接存储在`chat_sessions.note`字段
- 推荐使用`PUT`接口进行创建和更新,避免冲突
- 备注支持多行文本,建议使用`\n`换行
- 备注不记录创建人和修改人信息,由`chat_sessions`表的`updated_at`记录最后修改时间

### 8.3 快捷回复
- 系统预设的快捷回复不可修改和删除
- 每个客服只能看到系统预设和自己创建的快捷回复
- 建议使用分类(category)组织快捷回复,便于管理

---

## 九、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2024-01-20 | 初始版本,包含标签、备注、快捷回复完整功能 |

---

## 十、联系方式

如有问题或建议,请联系技术支持团队。
